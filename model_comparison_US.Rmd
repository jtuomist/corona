---
title: "R Notebook"
output:
  html_document:
    df_print: paged
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r preprocess}
library(ggplot2)
library(reshape2)
#library(tidyquant)

```

```{r data}

df <- read.fwf("~/Downloads/Preliminary Assessment of Model State Forecasts of Deaths due to COVID19.dtt",
               widths=c(5,9,6,15,4,15,15,15,15,15,225),stringsAsFactors=FALSE, skip=1)
colnames(df) <- c("row","model","num","date","scale","Q5","Q25","Q50","Q75","Q95","name")
for(i in c(2,4,5,11)) df[[i]] <- trimws(df[[i]])
for(i in 6:10) df[[i]] <- ifelse(df[[i]]<0,NA,df[[i]])
df$state <- substr(df$date,1,2)

real <- read.fwf("~/Downloads/Preliminary Assessment of Model State Forecasts of Deaths due to COVID19.rls",
                   widths=c(6,15,15,4,175),stringsAsFactors=FALSE, skip=0)
colnames(real) <- c("row","date","rls","scale","name")
for(i in c(2,4,5)) real[[i]] <- trimws(real[[i]])

df <- merge(df, real[2:4])
df$date <- gsub(" 7/4", " 7/04", df$date)

weights <- data.frame(
  model = c(
    "Covid19S",
    "COVhub-b",
    "COVhub-e",
    "CU",
    "epiforec",
    "JHU",
    "LANL",
    "MOBS",
    "NotreDam",
    "OliverWy",
    "UA",
    "UCLA",
    "UMass",
    "ERDC",
    "UT",
    "YYG"
  ),
  weight=  c(
     0,
     0,
     0.16,
     0,
     0,
     0.01,
     0.01,
     0,
     0,
     0.26,
     0,
     0,
     0.30,
     0,
     0.24,
     0.01
  )
)

df <- merge(df, weights, all.x=TRUE)

```

```{r graphs}

# Model predictions and realisations without weights

ggplot(df, aes(x=date, colour=state, group=state, y=Q50))+geom_line()+
  geom_point(aes(y=rls))+
  geom_ribbon(aes(ymin=Q5, ymax=Q95), fill="grey50", alpha=0.2, size=0.2)+
  facet_wrap(~model)+
  theme(axis.text.x = element_text(angle = 90, vjust=0.5))+
  coord_cartesian(ylim=c(0,1500))+
  labs(
    title="Predicted COVID-19 cases with medians and 90 % CI (lines) and actual realisations (dots) in four states",
    y="Number of COVID-19 cases per week",
    x="State and week"
  )

ggsave("All model calibration timeline wo weights.png", height=8, width=14)  

# Model predictions and realisations with weights

ggplot(df[!is.na(df$weight),], aes(x=date, colour=state, group=state, y=Q50))+geom_line()+
  geom_point(aes(y=rls))+
  geom_ribbon(aes(ymin=Q5, ymax=Q95), fill="grey50", alpha=0.2, size=0.2)+
  facet_wrap(~paste0(model,": weight ", weight))+
  theme(axis.text.x = element_text(angle = 90, vjust=0.5))+
  coord_cartesian(ylim=c(0,1500))+
  labs(
    title="Predicted COVID-19 cases with medians and 90 % CI (lines) and actual realisations (dots) in four states",
    y="Number of COVID-19 cases per week",
    x="State and week"
  )

ggsave("Model calibration timeline w_ weights.png", height=8, width=14)  

ggplot(df[!is.na(df$weight) & df$weight > 0.1,], aes(x=date, colour=state, group=state, y=Q50))+geom_line()+
  geom_point(aes(y=rls))+
  geom_ribbon(aes(ymin=Q5, ymax=Q95), fill="grey50", alpha=0.2, size=0.2)+
  facet_wrap(~paste0(model,": weight ", weight))+
  theme(axis.text.x = element_text(angle = 90, vjust=0.5))+
  coord_cartesian(ylim=c(0,1500))+
  labs(
    title="Predicted COVID-19 cases with medians and 90 % CI (lines) and actual realisations (dots) in four states",
    y="Number of COVID-19 cases per week",
    x="State and week"
  )

ggsave("Best model calibration timeline w_ weights.png", height=8, width=14)  

```